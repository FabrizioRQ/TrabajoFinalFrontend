<!-- lista-usuarios.html -->
<div class="container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Lista de Usuarios</mat-card-title>
    </mat-card-header>

    <mat-card-content>

      <!-- Selector de tipo de consulta -->
      <div class="filtros-container">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Tipo de Consulta</mat-label>
          <mat-select [(value)]="tipoConsulta" (selectionChange)="ejecutarConsulta()">
            <mat-option value="todos">Todos los usuarios</mat-option>
            <mat-option value="porRol">Por rol específico</mat-option>
            <mat-option value="inicioNombre">Por inicio del nombre</mat-option>
            <mat-option value="psicologos">Solo psicólogos</mat-option>
            <mat-option value="avanzada">Búsqueda avanzada</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Filtro por rol -->
        <div *ngIf="tipoConsulta === 'porRol'" class="filtro-group">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Rol a buscar</mat-label>
            <input matInput [(ngModel)]="rol" placeholder="Ej: ADMIN, USER">
          </mat-form-field>
          <button mat-raised-button color="primary" (click)="ejecutarConsulta()">
            Buscar por Rol
          </button>
        </div>

        <!-- Filtro por inicio del nombre -->
        <div *ngIf="tipoConsulta === 'inicioNombre'" class="filtro-group">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Texto del nombre</mat-label>
            <input matInput [(ngModel)]="textoNombre" placeholder="Ej: Juan, Maria">
          </mat-form-field>
          <button mat-raised-button color="primary" (click)="ejecutarConsulta()">
            Buscar por Nombre
          </button>
        </div>

        <!-- Búsqueda avanzada -->
        <div *ngIf="tipoConsulta === 'avanzada'" class="filtros-avanzados">
          <div class="filtros-row">
            <mat-form-field appearance="outline">
              <mat-label>Correo</mat-label>
              <input matInput [(ngModel)]="correo" placeholder="correo@ejemplo.com">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Nombre</mat-label>
              <input matInput [(ngModel)]="nombre" placeholder="Nombre completo">
            </mat-form-field>
          </div>

          <div class="filtros-row">
            <mat-form-field appearance="outline">
              <mat-label>Tipo de Usuario</mat-label>
              <mat-select [(value)]="tipoUsuario">
                <mat-option value="">Todos</mat-option>
                <mat-option *ngFor="let tipo of tiposUsuario" [value]="tipo">
                  {{ tipo }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Estado</mat-label>
              <mat-select [(value)]="estado">
                <mat-option value="">Todos</mat-option>
                <mat-option *ngFor="let estado of estadosUsuario" [value]="estado">
                  {{ estado }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="filtros-row">
            <mat-form-field appearance="outline">
              <mat-label>Rol específico</mat-label>
              <input matInput [(ngModel)]="rolAvanzado" placeholder="Rol específico">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Ordenar por</mat-label>
              <mat-select [(value)]="ordenarPor">
                <mat-option *ngFor="let campo of opcionesOrdenar" [value]="campo">
                  {{ campo }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Orden</mat-label>
              <mat-select [(value)]="orden">
                <mat-option *ngFor="let orden of opcionesOrden" [value]="orden">
                  {{ orden === 'asc' ? 'Ascendente' : 'Descendente' }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="acciones-filtros">
            <button mat-raised-button color="primary" (click)="ejecutarConsulta()">
              Buscar Avanzado
            </button>
            <button mat-button (click)="limpiarFiltros()">
              Limpiar
            </button>
          </div>
        </div>

        <!-- Botón para psicólogos -->
        <div *ngIf="tipoConsulta === 'psicologos'" class="filtro-group">
          <button mat-raised-button color="primary" (click)="ejecutarConsulta()">
            Cargar Psicólogos
          </button>
        </div>
      </div>

      <!-- Estados de carga y error -->
      <div *ngIf="cargando" class="loading-container">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Cargando usuarios...</p>
      </div>

      <div *ngIf="error && !cargando" class="error-container">
        <p class="error-message">{{ error }}</p>
        <button mat-raised-button color="primary" (click)="ejecutarConsulta()">
          Reintentar
        </button>
      </div>

      <!-- Tabla de resultados -->
      <div *ngIf="!cargando && !error" class="table-container">
        <table mat-table [dataSource]="usuarios" class="mat-elevation-z8">

          <ng-container matColumnDef="nombreCompleto">
            <th mat-header-cell *matHeaderCellDef> Nombre Completo </th>
            <td mat-cell *matCellDef="let usuario"> {{ usuario.nombreCompleto }} </td>
          </ng-container>

          <ng-container matColumnDef="tipoUsuario">
            <th mat-header-cell *matHeaderCellDef> Tipo de Usuario </th>
            <td mat-cell *matCellDef="let usuario">
              <span [class]="'badge ' + getTipoUsuarioClass(usuario.tipoUsuario)">
                {{ usuario.tipoUsuario }}
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="correoElectronico">
            <th mat-header-cell *matHeaderCellDef> Correo Electrónico </th>
            <td mat-cell *matCellDef="let usuario"> {{ usuario.correoElectronico }} </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="columnasMostradas"></tr>
          <tr mat-row *matRowDef="let row; columns: columnasMostradas;"></tr>
        </table>

        <div *ngIf="usuarios.length === 0" class="no-data">
          <p>No se encontraron usuarios</p>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
